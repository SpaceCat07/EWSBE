name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ghcr.io/${{ github.repository }}/ewsbe:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/image.tar

    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: /tmp/image.tar

  push:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: /tmp

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/ewsbe
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Load and push Docker image
      run: |
        docker load < /tmp/image.tar
        for tag in $(echo ${{ steps.meta.outputs.tags }} | tr ',' '\n'); do
          docker tag ghcr.io/${{ github.repository }}/ewsbe:latest $tag
          docker push $tag
        done

  deploy:
    name: Deploy to VPS
    needs: push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deployment secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Deployment skipped (missing secrets)"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üîê Secrets OK"
          fi

      - name: Deploy via SSH
        if: steps.check_secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            cd /var/www/ewsbe || exit 1

            echo "üì• Fetching latest code..."
            # Mencegah conflict dengan cara reset hard ke origin/main
            git fetch --all
            git reset --hard origin/main

            echo "‚¨áÔ∏è Pulling latest images..."
            # Pull image terbaru dari GHCR
            docker-compose pull app

            echo "üèóÔ∏è Restarting containers..."
            # Workaround for docker-compose v1.29.2 KeyError: 'ContainerConfig'
            # We must stop containers completely before recreating them
            docker-compose down --remove-orphans
            
            # Recreate container dengan image baru
            docker-compose up -d

            echo "üßπ Cleaning up unused images..."
            docker image prune -a -f

            echo "‚è≥ Waiting for containers..."
            sleep 15

            echo "üìä Container status:"
            docker-compose ps
            
            echo "‚úÖ Deployment Completed!"

      - name: Health Check
        if: steps.check_secrets.outputs.skip != 'true'
        run: |
          echo "üè• Checking health..."
          sleep 10
          # Port disesuaikan dengan docker-compose.yml (8080)
          curl -f http://localhost:8080/ || echo "‚ö†Ô∏è Health check possibly failed."

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ steps.check_secrets.outputs.skip }}" == "true" ]; then
            echo "‚ö†Ô∏è Deployment skipped"
          else
            echo "üöÄ Deployment finished! URL: http://your-domain.com:8080/"
          fi